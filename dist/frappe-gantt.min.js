/*! frappe-gantt 22-10-2016 01:10 */
!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){this._type="instance",!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d._type="class",d.prototype.constructor=d,d.extend=arguments.callee,d}}();var Gantt=Class.extend({init:function(a){this.opts=a,this.events=this.opts.events,this.set_defaults(),this.prepare(),this.render()},set_defaults:function(){var a={label_width:38,header_height:50,column_width:30,step:24,valid_view_modes:["Quarter Day","Half Day","Day","Week","Month"],bar:{height:20},arrow:{curve:5},view_mode:"Day",padding:18,date_format:"DD-MM-YYYY"};for(var b in a)a.hasOwnProperty(b)&&(this.opts[b]||(this.opts[b]=a[b]));this._bars=[],this._arrows=[],this.groups={};var c=this;this.tasks=this.opts.tasks.map(function(a,b){return a._start=moment(a.start,c.opts.date_format),a._end=moment(a.end,c.opts.date_format),a._index=b,a.start&&a.end||(a._start=moment().startOf("day"),a._end=moment().startOf("day").add(2,"days"),a.invalid=!0),a}),this.set_scale(this.opts.view_mode)},prepare:function(){this.start=this.end=void 0,this.prepare_dates(),this.render_canvas()},render:function(){this.clear(),this.setup_groups(),this.make_grid(),this.make_dates(),this.make_bars(),this.make_arrows(),this.set_arrows_on_bars(),this.setup_events(),this.set_width(),this.set_scroll_position(),this.bind()},bind:function(){this.bind_grid_click()},render_canvas:function(){this.canvas=Snap(this.opts.parent_selector),this.canvas.addClass("gantt")},clear:function(){this.canvas.clear(),this._bars=[],this._arrows=[]},prepare_dates:function(){var a=this;this.tasks.forEach(function(b){(!a.start||b._start<a.start)&&(a.start=b._start),(!a.end||b._end>a.end)&&(a.end=b._end)}),this.set_gantt_dates(),this.setup_dates()},set_gantt_dates:function(){var a=this;a.view_is(["Quarter Day","Half Day"])?(a.start=a.start.clone().subtract(7,"day"),a.end=a.end.clone().add(7,"day")):a.view_is("Month")?(a.start=a.start.clone().startOf("year"),a.end=a.end.clone().endOf("month").add(1,"year")):(a.start=a.start.clone().startOf("month").subtract(1,"month"),a.end=a.end.clone().endOf("month").add(1,"month"))},setup_dates:function(){this.dates=[];for(var a=null;null===a||a<this.end;)a=a?this.view_is("Month")?a=a.clone().add(1,"month"):a.clone().add(this.opts.step,"hours"):this.start.clone(),this.dates.push(a)},setup_groups:function(){var a=this;["grid","date","arrow","progress","bar","details"].forEach(function(b){a.groups[b]=a.canvas.group().attr({id:b})})},get_view_modes:function(){return this.opts.valid_view_modes||[]},set_view_mode:function(a){this.set_scale(a),this.prepare(),this.render()},set_scale:function(a){this.view_mode=a,this.events.on_viewmode_change(a),"Day"===a?(this.opts.step=24,this.opts.column_width=38):"Half Day"===a?(this.opts.step=12,this.opts.column_width=38):"Quarter Day"===a?(this.opts.step=6,this.opts.column_width=38):"Week"===a?(this.opts.step=168,this.opts.column_width=140):"Month"===a&&(this.opts.step=720,this.opts.column_width=120)},add_task:function(a){a._index=this.tasks.length,this.tasks.push(a),this.prepare_dates()},set_width:function(){var a=this.canvas.node.getBoundingClientRect().width,b=this.canvas.getBBox().width;a<b&&this.canvas.attr("width",b)},set_scroll_position:function(){document.querySelector(this.opts.parent_selector).parentElement.scrollLeft=this.get_min_date().diff(this.start,"hours")/this.opts.step*this.opts.column_width},get_min_date:function(){return this.tasks.reduce(function(a,b){return b._start.isSameOrBefore(a._start)?b:a})._start},make_grid:function(){this.make_grid_background(),this.make_grid_rows(),this.make_grid_header(),this.make_grid_ticks(),this.make_grid_highlights()},make_grid_background:function(){var a=this,b=this.opts.label_width+this.dates.length*this.opts.column_width,c=this.opts.header_height+this.opts.padding+(this.opts.bar.height+this.opts.padding)*this.tasks.length;this.canvas.rect(0,0,b,c).addClass("grid-background").appendTo(this.groups.grid),this.canvas.attr({height:c+a.opts.padding,width:"100%"})},make_grid_header:function(){var a=this,b=this.opts.label_width+this.dates.length*this.opts.column_width,c=this.opts.header_height+10;a.canvas.rect(0,0,b,c).addClass("grid-header").appendTo(a.groups.grid)},make_grid_rows:function(){var a=this,b=a.canvas.group().appendTo(a.groups.grid),c=a.canvas.group().appendTo(a.groups.grid),d=a.opts.label_width+a.dates.length*a.opts.column_width,e=a.opts.bar.height+a.opts.padding,f=a.opts.header_height+a.opts.padding/2;this.tasks.forEach(function(g,h){var i=h%2?"row-odd":"row-even";a.canvas.rect(0,f,d,e).addClass(i).appendTo(b),a.canvas.line(0,f+e,d,f+e).addClass("row-line").appendTo(c),f+=a.opts.bar.height+a.opts.padding})},make_grid_ticks:function(){var a=this,b=a.opts.label_width,c=a.opts.header_height+a.opts.padding/2,d=(a.opts.bar.height+a.opts.padding)*a.tasks.length;this.dates.forEach(function(e){var f="tick";"Day"===a.view_mode&&1===e.day()&&(f+=" thick"),"Week"===a.view_mode&&e.date()>=1&&e.date()<8&&(f+=" thick"),"Month"===a.view_mode&&e.month()%3===0&&(f+=" thick"),a.canvas.path(Snap.format("M {x} {y} v {height}",{x:b,y:c,height:d})).addClass(f).appendTo(a.groups.grid),b+="Month"===a.view_mode?e.daysInMonth()*a.opts.column_width/30:a.opts.column_width})},make_grid_highlights:function(){var a=this;if("Day"===a.view_mode){var b=a.opts.label_width+moment().startOf("day").diff(a.start,"hours")/a.opts.step*a.opts.column_width,c=0,d=a.opts.column_width,e=(a.opts.bar.height+a.opts.padding)*a.tasks.length+a.opts.header_height+a.opts.padding/2;a.canvas.rect(b,c,d,e).addClass("today-highlight").appendTo(a.groups.grid)}},make_dates:function(){var a=this;this.dates.forEach(function(b,c){var d="",e="";0===c?(d=a.get_date_text(b,"primary"),e=a.get_date_text(b)):"Day"===a.view_mode?(d=b.date()!==a.dates[c-1].date()?a.get_date_text(b,"primary"):"",e=b.month()!==a.dates[c-1].month()?a.get_date_text(b):""):"Quarter Day"===a.view_mode?(d=a.get_date_text(b,"primary"),e=b.date()!==a.dates[c-1].date()?a.get_date_text(b):""):"Half Day"===a.view_mode?(d=a.get_date_text(b,"primary"),e=b.date()!==a.dates[c-1].date()?a.get_date_text(b):""):"Week"===a.view_mode?(d=a.get_date_text(b,"primary"),e=b.month()!==a.dates[c-1].month()?a.get_date_text(b):""):"Month"===a.view_mode&&(d=a.get_date_text(b,"primary"),e=b.year()!==a.dates[c-1].year()?a.get_date_text(b):"");var f=a.opts.label_width+c*a.opts.column_width,g=a.opts.header_height,h=a.opts.label_width+c*a.opts.column_width,i=a.opts.header_height-25;if("Month"===a.view_mode&&(f+=b.daysInMonth()*a.opts.column_width/30/2,h+=12*a.opts.column_width/2),"Week"===a.view_mode&&(f+=a.opts.column_width/2,h+=4*a.opts.column_width/2),"Day"===a.view_mode&&(f+=a.opts.column_width/2,h+=30*a.opts.column_width/2),"Quarter Day"===a.view_mode&&(h+=4*a.opts.column_width/2),"Half Day"===a.view_mode&&(h+=2*a.opts.column_width/2),a.canvas.text(f,g,d).addClass("primary-text").appendTo(a.groups.date),e){var j=a.canvas.text(h,i,e).addClass("secondary-text").appendTo(a.groups.date);j.getBBox().x2>a.groups.grid.getBBox().width&&j.remove()}})},get_date_text:function(a,b){var c=this.view_mode,d="";return"Day"===c?d=b?a.format("D"):a.format("MMMM"):"Quarter Day"===c||"Half Day"===c?d=b?a.format("HH"):a.format("D MMM"):"Week"===c?d=b?"Week "+a.format("W"):a.format("MMMM"):"Month"===c&&(d=b?a.format("MMMM"):a.format("YYYY")),d},make_arrows:function(){var a=this;this.tasks.forEach(function(b){if(b.dependent){var c=b.dependent.split(",");c.forEach(function(c){var d=a.get_task(c.trim());if(d){var e=new Arrow({gantt:a,from_task:a._bars[d._index],to_task:a._bars[b._index]});a.groups.arrow.add(e.element),a._arrows.push(e)}})}})},make_label:function(){var a=this,b=a.opts.label_width-a.opts.padding,c=a.opts.header_height+a.opts.bar.height/2+a.opts.padding;this.tasks.forEach(function(d){a.canvas.text(b,c,d.name).appendTo(a.groups.label),c+=a.opts.bar.height+a.opts.padding}),a.groups.label.attr({"text-anchor":"end","dominant-baseline":"central"})},make_bars:function(){var a=this;this.tasks.forEach(function(b,c){var d=new Bar({canvas:a.canvas,task:b,gantt:{offset:a.opts.label_width,unit_width:a.opts.column_width,step:a.opts.step,start:a.start,header_height:a.opts.header_height,padding:a.opts.padding,view_mode:a.view_mode},popover_group:a.groups.details});a._bars.push(d),a.groups.bar.add(d.group)})},set_arrows_on_bars:function(){var a=this;this._bars.forEach(function(b){b.arrows=a._arrows.filter(function(a){if(a.from_task.task.id===b.task.id||a.to_task.task.id===b.task.id)return a})})},setup_events:function(){var a=this;this._bars.forEach(function(b){b.events.on_date_change=a.events.bar_on_date_change,b.events.on_progress_change=a.events.bar_on_progress_change,b.click(a.events.bar_on_click)})},bind_grid_click:function(){var a=this;this.groups.grid.click(function(){a.canvas.selectAll(".bar-wrapper").forEach(function(a){a.removeClass("active")})})},view_is:function(a){var b=this;return"string"==typeof a?b.view_mode===a:void a.reduce(function(a,c){return b.view_mode===c||a},!1)},get_task:function(a){var b=null;return this.tasks.forEach(function(c){c.id===a&&(b=c)}),b}}),Bar=Class.extend({init:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.set_defaults(),this.prepare(),this.draw(),this.bind(),this.action_completed=!1},set_defaults:function(){var a={height:20,corner_radius:3,events:{}};for(var b in a)a.hasOwnProperty(b)&&(this[b]||(this[b]=a[b]))},prepare:function(){this.prepare_values(),this.prepare_plugins()},prepare_values:function(){this.task.start&&this.task.end||(this.invalid=!0),this.x=this.compute_x(),this.y=this.compute_y(),this.duration=(this.task._end.diff(this.task._start,"hours")+24)/this.gantt.step,this.width=this.gantt.unit_width*this.duration,this.progress_width=this.gantt.unit_width*this.duration*(this.task.progress/100)||0,this.group=this.canvas.group().addClass("bar-wrapper"),this.bar_group=this.canvas.group().addClass("bar-group").appendTo(this.group),this.handle_group=this.canvas.group().addClass("handle-group").appendTo(this.group)},prepare_plugins:function(){this.filters={},Snap.plugin(function(a,b,c,d,e){b.prototype.get=function(a){return+this.attr(a)},b.prototype.getX=function(){return this.get("x")},b.prototype.getEndX=function(){return this.getX()+this.getWidth()},b.prototype.getY=function(){return this.get("y")},b.prototype.getWidth=function(){return this.get("width")}})},draw:function(){this.draw_bar(),this.draw_progress_bar(),this.draw_label(),this.draw_resize_handles()},draw_bar:function(){this.$bar=this.canvas.rect(this.x,this.y,this.width,this.height,this.corner_radius,this.corner_radius).addClass("bar").appendTo(this.bar_group),this.invalid&&this.$bar.addClass("bar-invalid")},draw_progress_bar:function(){this.invalid||(this.$bar_progress=this.canvas.rect(this.x,this.y,this.progress_width,this.height,this.corner_radius,this.corner_radius).addClass("bar-progress").appendTo(this.bar_group))},draw_label:function(){this.canvas.text(this.x+this.width/2,this.y+this.height/2,this.task.name).addClass("bar-label").appendTo(this.bar_group),this.update_label_position()},draw_resize_handles:function(){if(!this.invalid){var a=this.$bar,b=this.$bar_progress;this.canvas.rect(a.getX()+a.getWidth()-9,a.getY()+1,8,this.height-2,this.corner_radius,this.corner_radius).addClass("handle right").appendTo(this.handle_group),this.canvas.rect(a.getX()+1,a.getY()+1,8,this.height-2,this.corner_radius,this.corner_radius).addClass("handle left").appendTo(this.handle_group),this.task.progress&&this.task.progress<100&&this.canvas.polygon(b.getEndX()-5,b.getY()+b.get("height"),b.getEndX()+5,b.getY()+b.get("height"),b.getEndX(),b.getY()+b.get("height")-8.66).addClass("handle progress").appendTo(this.handle_group)}},draw_invalid_bar:function(){var a=this.gantt.offset+moment().startOf("day").diff(this.gantt.start,"hours")/this.gantt.step*this.gantt.unit_width;this.canvas.rect(a,this.y,2*this.gantt.unit_width,this.height,this.corner_radius,this.corner_radius).addClass("bar-invalid").appendTo(this.bar_group),this.canvas.text(a+this.gantt.unit_width,this.y+this.height/2,"Dates not set").addClass("bar-label big").appendTo(this.bar_group)},bind:function(){this.invalid||(this.show_details(),this.bind_resize(),this.bind_drag(),this.bind_resize_progress())},show_details:function(){var a=this,b=a.popover_group.select(".details-wrapper");b||(b=a.canvas.group().addClass("details-wrapper"),b.appendTo(a.popover_group),a.canvas.rect(0,0,0,110,2,2).addClass("details-container").appendTo(b),a.canvas.text(0,0,"").attr({dx:10,dy:30}).addClass("details-heading").appendTo(b),a.canvas.text(0,0,"").attr({dx:10,dy:65}).addClass("details-body").appendTo(b),a.canvas.text(0,0,"").attr({dx:10,dy:90}).addClass("details-body").appendTo(b)),this.group.mouseover(function(c,d,e){a.popover_group.removeClass("hide");var f=a.get_details_position();b.transform("t"+f.x+","+f.y);var g=a.task.name+": "+a.task._start.format("MMM D")+" - "+a.task._end.format("MMM D"),h=a.popover_group.select(".details-heading");h.attr("text",g);var i=h.getBBox();b.select(".details-container").attr({width:i.width+20});var j="Duration: "+a.task._end.diff(a.task._start,"days")+" days",k=a.task.progress?"Progress: "+a.task.progress+"%":"",l=a.popover_group.selectAll(".details-body");l[0].attr("text",j),l[1].attr("text",k)}),this.group.mouseout(function(){setTimeout(function(){a.popover_group.addClass("hide")},500)})},get_details_position:function(){return{x:this.$bar.getEndX()+2,y:this.$bar.getY()-10}},bind_resize:function(){function a(){g.ox=g.getX(),g.oy=g.getY(),g.owidth=g.getWidth(),this.ox=this.getX(),this.oy=this.getY(),g.finaldx=0}function b(a,b){g.finaldx=f.get_snap_position(f,g,a),f.update_bar_position(null,g.owidth+g.finaldx)}function c(){g.finaldx&&f.date_changed(),f.set_action_completed()}function d(a,b){g.finaldx=f.get_snap_position(a),f.update_bar_position(g.ox+g.finaldx,g.owidth-g.finaldx)}function e(){g.finaldx&&f.date_changed(),f.set_action_completed()}var f=this,g=this.$bar,h=f.get_handles();h.right.drag(b,a,c),h.left.drag(d,a,e)},get_handles:function(){var a=this;return{left:a.handle_group.select(".handle.left"),right:a.handle_group.select(".handle.right")}},bind_drag:function(){function a(a,b){e.finaldx=d.get_snap_position(a),d.update_bar_position(e.ox+e.finaldx)}function b(){e.finaldx&&(d.date_changed(),d.set_action_completed())}function c(){e.ox=e.getX(),e.finaldx=0}var d=this,e=this.$bar;this.bar_group.drag(a,c,b)},bind_resize_progress:function(){function a(a,b){a>f.max_dx&&(a=f.max_dx),a<f.min_dx&&(a=f.min_dx),f.attr("width",f.owidth+a),g.transform("t"+a+",0"),f.finaldx=a}function b(){f.finaldx&&(d.progress_changed(),d.set_action_completed())}function c(){f.finaldx=0,f.owidth=f.getWidth(),f.min_dx=-f.getWidth(),f.max_dx=e.getWidth()-f.getWidth()}var d=this,e=this.$bar,f=this.$bar_progress,g=d.group.select(".handle.progress");g&&g.drag(a,c,b)},view_is:function(a){var b=this;if("string"==typeof a)return b.gantt.view_mode===a;for(var c=0;c<a.length;c++)if(b.gantt.view_mode===a[c])return!0;return!1},update_bar_position:function(a,b){var c=this.$bar;a&&this.update_attr(c,"x",a),b&&this.update_attr(c,"width",b),this.update_label_position(),this.update_handle_position(),this.update_progressbar_position(),this.update_arrow_position(),this.update_details_position()},click:function(a){var b=this;this.group.click(function(){b.action_completed||(b.group.hasClass("active")&&a(b.task),b.unselect_all(),b.group.toggleClass("active"))})},date_changed:function(){this.events.on_date_change&&this.events.on_date_change(this.task,this.compute_start_date(),this.compute_end_date())},progress_changed:function(){this.events.on_progress_change&&this.events.on_progress_change(this.task,this.compute_progress())},set_action_completed:function(){var a=this;this.action_completed=!0,setTimeout(function(){a.action_completed=!1},2e3)},compute_date:function(a){var b=(a-this.compute_x())/this.gantt.unit_width,c=this.task._start.clone().add(this.gantt.step*b,"hours");return c},compute_start_date:function(){var a=this.$bar,b=(a.getX()-this.compute_x())/this.gantt.unit_width,c=this.task._start.clone().add(this.gantt.step*b,"hours");return c},compute_end_date:function(){var a=this.$bar,b=this.compute_x()+this.duration*this.gantt.unit_width,c=a.getEndX(),d=(c-b)/this.gantt.unit_width,e=this.task._end.clone().add(this.gantt.step*d,"hours");return e},compute_progress:function(){return this.$bar_progress.getWidth()/this.$bar.getWidth()*100},compute_x:function(){var a=this.gantt.offset+this.task._start.diff(this.gantt.start,"hours")/this.gantt.step*this.gantt.unit_width;return this.view_is("Month")&&(a=this.gantt.offset+this.task._start.diff(this.gantt.start,"days")*this.gantt.unit_width/30),a},compute_y:function(){return this.gantt.header_height+this.gantt.padding+this.task._index*(this.height+this.gantt.padding)},get_snap_position:function(a){var b,c,d=this,e=a;return d.view_is("Week")?(b=a%(d.gantt.unit_width/7),c=e-b+(b<d.gantt.unit_width/14?0:d.gantt.unit_width/7)):d.view_is("Month")?(b=a%(d.gantt.unit_width/30),c=e-b+(b<d.gantt.unit_width/60?0:d.gantt.unit_width/30)):(b=a%d.gantt.unit_width,c=e-b+(b<d.gantt.unit_width/2?0:d.gantt.unit_width)),c},update_attr:function(a,b,c){return c=+c,isNaN(c)||a.attr(b,c),a},update_progressbar_position:function(){this.$bar_progress.attr("x",this.$bar.getX()),this.$bar_progress.attr("width",this.$bar.getWidth()*(this.task.progress/100))},update_label_position:function(){var a=this.$bar,b=this.group.select(".bar-label");b.getBBox().width>a.getWidth()?b.addClass("big").attr("x",a.getX()+a.getWidth()+5):b.removeClass("big").attr("x",a.getX()+a.getWidth()/2)},update_handle_position:function(){var a=this.$bar;this.handle_group.select(".handle.left").attr({x:a.getX()+1}),this.handle_group.select(".handle.right").attr({x:a.getX()+a.getWidth()-9})},update_arrow_position:function(){this.arrows.forEach(function(a){a.update()})},update_details_position:function(){var a=this.popover_group.select(".details-wrapper"),b=this.get_details_position();a.transform("t"+b.x+","+b.y)},unselect_all:function(){this.canvas.selectAll(".bar-wrapper").forEach(function(a){a.removeClass("active")})}}),Arrow=Class.extend({init:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.prepare(),this.draw()},prepare:function(){var a=this.gantt,b=this.from_task,c=this.to_task;for(this.start_x=b.$bar.getX()+b.$bar.getWidth()/2;c.$bar.getX()<this.start_x+a.opts.padding&&this.start_x>b.$bar.getX()+a.opts.padding;)this.start_x-=10;this.start_y=a.opts.header_height+a.opts.bar.height+(a.opts.padding+a.opts.bar.height)*b.task._index+a.opts.padding,this.end_x=c.$bar.getX()-a.opts.padding/2,this.end_y=a.opts.header_height+a.opts.bar.height/2+(a.opts.padding+a.opts.bar.height)*c.task._index+a.opts.padding;var d=b.task._index>c.task._index;this.curve=a.opts.arrow.curve,this.clockwise=d?1:0,this.curve_y=d?-this.curve:this.curve,this.offset=d?this.end_y+a.opts.arrow.curve:this.end_y-a.opts.arrow.curve,this.path=Snap.format("M {start_x} {start_y} V {offset} a {curve} {curve} 0 0 {clockwise} {curve} {curve_y} L {end_x} {end_y} m -5 -5 l 5 5 l -5 5",{start_x:this.start_x,start_y:this.start_y,end_x:this.end_x,end_y:this.end_y,offset:this.offset,curve:this.curve,clockwise:this.clockwise,curve_y:this.curve_y}),c.$bar.getX()<b.$bar.getX()+a.opts.padding&&(this.path=Snap.format("M {start_x} {start_y} v {down_1} a {curve} {curve} 0 0 1 -{curve} {curve} H {left} a {curve} {curve} 0 0 {clockwise} -{curve} {curve_y} V {down_2} a {curve} {curve} 0 0 {clockwise} {curve} {curve_y} L {end_x} {end_y} m -5 -5 l 5 5 l -5 5",{start_x:this.start_x,start_y:this.start_y,end_x:this.end_x,end_y:this.end_y,down_1:this.gantt.opts.padding/2-this.curve,down_2:c.$bar.getY()+c.$bar.get("height")/2-this.curve_y,left:c.$bar.getX()-a.opts.padding,offset:this.offset,curve:this.curve,clockwise:this.clockwise,curve_y:this.curve_y}))},draw:function(){this.element=this.gantt.canvas.path(this.path).attr("data-from",this.from_task.task.id).attr("data-to",this.to_task.task.id)},update:function(){this.prepare(),this.element.attr("d",this.path)}});